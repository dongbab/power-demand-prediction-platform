<script>
    import { onMount, onDestroy, tick } from "svelte";
    import MetricCard from "./MetricCard.svelte";
    import DistributionChart from "./DistributionChart.svelte";
    import MonthlyChart from "./MonthlyChart.svelte";
    import LoadingSpinner from "../LoadingSpinner.svelte";

    export let stationId;
    export let analysis = null;

    let isLoading = false;
    let lastUpdated = null;
    let refreshInterval;
    let energyForecast = null;
    let selectedTimeframe = "90days";
    let chartContainer;

    // Îç∞Ïù¥ÌÑ∞ Î≤îÏúÑ Ï†ïÎ≥¥
    let dataRange = {
        startDate: null,
        endDate: null,
        recordCount: 0,
    };

    const timeframes = [
        { value: "30days", label: "30Ïùº" },
        { value: "90days", label: "90Ïùº" },
        { value: "180days", label: "6Í∞úÏõî" },
        { value: "365days", label: "1ÎÖÑ" },
    ];

    let Chart;
    let chart; // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§

    onMount(async () => {
        // Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤ΩÏóêÏÑúÎßå Ïã§Ìñâ
        if (typeof window === 'undefined') return;
        
        try {
            // Chart.jsÏôÄ time adapter, zoom plugin Î°úÎìú (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï†ÑÏö©)
            const [{ default: ChartJS }, dateAdapter, zoomPlugin] =
                await Promise.all([
                    import("chart.js/auto"),
                    import("chartjs-adapter-date-fns"),
                    import("chartjs-plugin-zoom"),
                ]);
            Chart = ChartJS;
            Chart.register(zoomPlugin.default);

            // reactive statementÏóêÏÑú stationId Î≥ÄÍ≤Ω Ïãú ÏûêÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®
            console.log('PowerDemandPredictor onMount: Chart.js Î°úÎìú ÏôÑÎ£å, stationId =', stationId);
            // 60Î∂ÑÎßàÎã§ Í∞±Ïã†
            refreshInterval = setInterval(updateEnergyForecast, 60 * 60 * 1000);
        } catch (error) {}
    });

    onDestroy(() => {
        try {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            // Ï∞®Ìä∏ Ï†ïÎ¶¨
            if (chart) {
                chart.destroy();
                chart = null;
            }
        } catch (error) {}
    });

    async function updateEnergyForecast() {
        if (!stationId) {
            console.log('PowerDemandPredictor: stationIdÍ∞Ä ÏóÜÏäµÎãàÎã§');
            return;
        }

        console.log('üöÄ PowerDemandPredictor: Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏãúÏûë, stationId:', stationId);
        console.log('ÌòÑÏû¨ selectedTimeframe:', selectedTimeframe);
        isLoading = true;

        try {
            const days = parseInt(selectedTimeframe.replace("days", ""));
            const url = `/api/stations/${encodeURIComponent(stationId)}/energy-demand-forecast?days=${days}`;
            console.log('üì° API Ìò∏Ï∂ú URL:', url);

            const response = await fetch(url, {
                cache: "no-cache",
                signal: AbortSignal.timeout(15000),
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                },
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status} ${response.statusText}`, errorText);
                throw new Error(
                    `API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status} ${response.statusText}`
                );
            }

            const result = await response.json();
            console.log('API ÏùëÎãµ:', result);
            console.log('ÏóêÎÑàÏßÄ ÌÜµÍ≥Ñ:', result?.energy_statistics);

            console.log('API ÏùëÎãµ Ï†ÑÏ≤¥:', result);
            console.log('result.success:', result.success);
            console.log('result.timeseries_data:', result.timeseries_data?.length);

            if (result.success && result.timeseries_data) {
                energyForecast = {
                    daily_consumption: result.timeseries_data,
                    energy_statistics: result.energy_statistics,
                    monthly_summary: result.monthly_summary,
                    insights: result.insights,
                    growth_rate: result.growth_rate
                };
                console.log('üéØ energyForecast ÏÉùÏÑ±Îê®:', energyForecast);
                console.log('üéØ daily_consumption Í∏∏Ïù¥:', energyForecast.daily_consumption.length);

                console.log('‚úÖ energyForecast ÏÑ§Ï†ï ÏôÑÎ£å');
                console.log('üìä Îç∞Ïù¥ÌÑ∞ Í∞úÏàò:', energyForecast.daily_consumption.length, 'Í∞ú');
                console.log('üìà ÏóêÎÑàÏßÄ ÌÜµÍ≥Ñ:', energyForecast.energy_statistics);

                // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î≤îÏúÑ ÏÑ§Ï†ï
                dataRange = {
                    startDate: new Date(result.data_range.start_date),
                    endDate: new Date(result.data_range.end_date),
                    recordCount: result.timeseries_data.length,
                };
                
                console.log('üìÖ dataRange ÏÑ§Ï†ïÎê®:', dataRange);
                console.log('üìÖ startDate:', dataRange.startDate);
                console.log('üìÖ endDate:', dataRange.endDate);

                lastUpdated = new Date();
            } else {
                throw new Error(result.error || "ÏóêÎÑàÏßÄ ÏòàÏ∏° Ïã§Ìå®");
            }
        } catch (error) {
            console.error('Energy forecast Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            energyForecast = null;
            dataRange = {
                startDate: null,
                endDate: null,
                recordCount: 0,
            };
        } finally {
            isLoading = false;
        }
    }

    function resetZoom() {
        if (typeof window !== 'undefined' && chart) {
            chart.resetZoom();
        }
    }

    // Reactive Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Í∞êÏßÄ -> Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
    $: if (
        typeof window !== 'undefined' &&
        energyForecast &&
        energyForecast.daily_consumption &&
        energyForecast.daily_consumption.length > 0 &&
        Chart &&
        chartContainer
    ) {
        console.log('üîÑ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ï°∞Í±¥ ÎßåÏ°± - Ï∞®Ìä∏ ÏÉùÏÑ± ÏãúÏûë');
        // DOMÏù¥ ÏóÖÎç∞Ïù¥Ìä∏Îê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶∞ ÌõÑ Ï∞®Ìä∏ ÏÉùÏÑ±/ÏóÖÎç∞Ïù¥Ìä∏
        tick().then(() => {
            setTimeout(() => {
                console.log('üìä createChart() Ìò∏Ï∂ú');
                createChart();
            }, 100);
        });
    } else if (typeof window !== 'undefined') {
        console.log('‚ùå Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ï°∞Í±¥ ÎØ∏Ï∂©Ï°±:', {
            energyForecast: !!energyForecast,
            daily_consumption: !!energyForecast?.daily_consumption,
            daily_consumption_length: energyForecast?.daily_consumption?.length || 0,
            Chart: !!Chart,
            chartContainer: !!chartContainer
        });
    }

    function fmtDate(d) {
        if (!d) return "-";
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${da}`;
    }

    function createChart() {
        // Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤Ω Ï≤¥ÌÅ¨
        if (typeof window === 'undefined') return;
        
        if (!chartContainer || !Chart || !energyForecast?.daily_consumption) {
            console.log('Ï∞®Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: ÏöîÍµ¨ÏÇ¨Ìï≠ ÎØ∏Ï∂©Ï°±', {
                chartContainer: !!chartContainer,
                Chart: !!Chart,
                daily_consumption: !!energyForecast?.daily_consumption
            });
            return;
        }

        // Í∏∞Ï°¥ Ï∞®Ìä∏ ÌååÍ¥¥
        if (chart) {
            chart.destroy();
            chart = null;
        }

        try {
            const ctx = chartContainer.getContext("2d");
            
            if (!ctx) {
                console.error('Ï∫†Î≤ÑÏä§ Ïª®ÌÖçÏä§Ìä∏Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
                return;
            }

            // Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ Î∞è Í≤ÄÏ¶ù
            const dailyData = energyForecast.daily_consumption;
            if (!dailyData || dailyData.length === 0) {
                console.log('Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§');
                return;
            }

            const actualData = dailyData.filter(item => item.type === 'actual').map(item => ({
                x: item.date,
                y: parseFloat(item.energy) || 0,
            }));
            
            const predictedData = dailyData.filter(item => item.type === 'predicted').map(item => ({
                x: item.date,
                y: parseFloat(item.energy) || 0,
            }));
            
            console.log('Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞:', actualData.slice(0, 3));
            console.log('ÏòàÏ∏° Îç∞Ïù¥ÌÑ∞:', predictedData.slice(0, 3));

            chart = new Chart(ctx, {
                type: "line",
                data: {
                    datasets: [
                        {
                            label: "Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ (kWh)",
                            data: actualData,
                            borderColor: "#2563eb",
                            backgroundColor: "rgba(37, 99, 235, 0.1)",
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            fill: false,
                            tension: 0.1,
                        },
                        {
                            label: "ÏòàÏ∏° Îç∞Ïù¥ÌÑ∞ (kWh)",
                            data: predictedData,
                            borderColor: "#f59e0b",
                            backgroundColor: "rgba(245, 158, 11, 0.1)",
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            fill: false,
                            tension: 0.1,
                            borderDash: [5, 5], // Ï†êÏÑ†ÏúºÎ°ú ÏòàÏ∏° Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: "index",
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            backgroundColor: "rgba(0,0,0,0.8)",
                            titleColor: "#fff",
                            bodyColor: "#fff",
                            borderColor: "#2563eb",
                            borderWidth: 1,
                            callbacks: {
                                label: function (context) {
                                    return `${context.parsed.y.toFixed(2)}kWh`;
                                },
                            },
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: "x",
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true,
                                },
                                mode: "x",
                            },
                        },
                    },
                    scales: {
                        x: {
                            type: "time",
                            time: {
                                unit: "day",
                                displayFormats: {
                                    day: "MM/dd",
                                },
                            },
                            title: {
                                display: true,
                                text: "ÎÇ†Ïßú",
                                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#e5e7eb' : '#374151',
                                font: { size: 14, weight: "bold" },
                            },
                            grid: { 
                                color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0,0,0,0.1)' 
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#d1d5db' : '#4b5563',
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "Ï†ÑÎ†•Îüâ (kWh)",
                                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#e5e7eb' : '#374151',
                                font: { size: 14, weight: "bold" },
                            },
                            grid: { 
                                color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0,0,0,0.1)' 
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#d1d5db' : '#4b5563',
                                callback: function (value) {
                                    return value + "kWh";
                                },
                            },
                        },
                    },
                },
            });
        } catch (error) {
            console.error("Ï∞®Ìä∏ ÏÉùÏÑ± Ïã§Ìå®:", error);
        }
    }
    
    // Ï∞®Ìä∏ Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä ÎßàÏö¥Ìä∏Îêú ÌõÑ Ï¥àÍ∏∞ Ï∞®Ìä∏ ÏÉùÏÑ± ÏãúÎèÑ
    $: if (typeof window !== 'undefined' && chartContainer && energyForecast && Chart) {
        setTimeout(() => {
            createChart();
        }, 200);
    }

    // stationIdÍ∞Ä Î≥ÄÍ≤ΩÎê† ÎïåÎßàÎã§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎßå)
    $: if (typeof window !== 'undefined' && stationId && stationId.trim()) {
        console.log('PowerDemandPredictor: stationId Î≥ÄÍ≤ΩÎê®:', stationId);
        updateEnergyForecast();
    } else if (typeof window !== 'undefined') {
        console.log('PowerDemandPredictor: stationIdÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå:', stationId);
    }

    // Ï∞®Ìä∏ ÌëúÏãú Ï°∞Í±¥ ÎîîÎ≤ÑÍπÖ
    $: {
        if (typeof window !== 'undefined') {
            console.log('üìä Ï∞®Ìä∏ ÌëúÏãú Ï°∞Í±¥ Ï≤¥ÌÅ¨:', {
                energyForecast: !!energyForecast,
                isLoading,
                hasDaily: !!(energyForecast?.daily_consumption && energyForecast.daily_consumption.length > 0),
                Chart: !!Chart,
                chartContainer: !!chartContainer,
                dailyConsumptionLength: energyForecast?.daily_consumption?.length || 0
            });
            
            if (energyForecast && !isLoading) {
                console.log('‚úÖ Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ ÏôÑÎ£å - Ï∞®Ìä∏Í∞Ä ÌëúÏãúÎêòÏñ¥Ïïº Ìï®');
            } else if (isLoading) {
                console.log('‚è≥ Î°úÎî© Ï§ë...');
            } else if (!energyForecast) {
                console.log('‚ùå energyForecast Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
            }
        }
    }

    // ÏãúÍ∞ÑÎåÄ Î≥ÄÍ≤Ω Ïãú Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î°úÎìú (Ï¥àÍ∏∞ Î°úÎìú Ï†úÏô∏)
    let initialized = false;
    $: {
        if (selectedTimeframe && initialized && stationId) {
            console.log('PowerDemandPredictor: timeframe Î≥ÄÍ≤ΩÎê®:', selectedTimeframe);
            updateEnergyForecast();
        }
    }

    // Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÌëúÏãú
    setTimeout(() => {
        initialized = true;
    }, 1000);

    $: averageDailyEnergy = energyForecast?.energy_statistics?.avg_daily || 0;
    $: totalEnergy = energyForecast?.energy_statistics?.total_energy || 0;
    $: growthRate = energyForecast?.growth_rate || 0;
    $: averageDemand = analysis?.current_statistics?.avg_power || 0;
    $: peakDemand = analysis?.predictions?.peak_power || 0;
    
    // Ï†ÑÎ†•Îüâ ÏòàÏ∏° Í∏∞Í∞Ñ ÏÑ§Ï†ï (ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉù Í∞ÄÎä•)
    let energyForecastPeriod = "daily"; // daily, weekly, monthly
    const forecastPeriods = [
        { value: "daily", label: "ÏùºÍ∞Ñ", multiplier: 1 },
        { value: "weekly", label: "Ï£ºÍ∞Ñ", multiplier: 7 },
        { value: "monthly", label: "ÏõîÍ∞Ñ", multiplier: 30 }
    ];

    // ÏòàÏÉÅ Ï†ÑÎ†•Îüâ ÏàòÏöîÎ•º Í∏∞Í∞ÑÎ≥ÑÎ°ú Í≥ÑÏÇ∞ (kWh) - API Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò
    $: predictedEnergyDemand = (() => {
        if (!energyForecast?.energy_statistics) {
            console.log('‚ùå energy_statistics ÏóÜÏùå');
            return 0;
        }

        const stats = energyForecast.energy_statistics;
        const avgDaily = stats.avg_daily || 0;
        const currentPeriod = forecastPeriods.find(p => p.value === energyForecastPeriod);
        
        console.log('üìä Ï†ÑÎ†•Îüâ Í≥ÑÏÇ∞:', {
            avgDaily,
            currentPeriod,
            energyForecastPeriod
        });
        
        if (!currentPeriod || avgDaily === 0) {
            return 0;
        }

        // Í∏∞Í∞ÑÎ≥Ñ ÏòàÏÉÅ Ï†ÑÎ†•Îüâ Í≥ÑÏÇ∞
        let baseEnergyDemand = avgDaily * currentPeriod.multiplier;
        
        // ÏÑ±Ïû•Î•† Î∞òÏòÅ (Ìñ•ÌõÑ ÏòàÏ∏° Ï°∞Ï†ï)
        if (growthRate > 0) {
            baseEnergyDemand *= (1 + growthRate / 100 * 0.5); // 50% Í∞ÄÏ§ëÏπòÎ°ú ÏÑ±Ïû•Î•† Î∞òÏòÅ
        }
        
        // Í≥ÑÏ†àÏÑ± ÏöîÏù∏ (ÌòÑÏû¨ Ïõî Í∏∞Ï§Ä)
        const currentMonth = new Date().getMonth() + 1;
        let seasonalFactor = 1.0;
        
        if (currentMonth >= 6 && currentMonth <= 8) {
            // Ïó¨Î¶ÑÏ≤† (6-8Ïõî): ÏóêÏñ¥Ïª® ÏÇ¨Ïö©ÏúºÎ°ú Ï†ÑÎ†• ÏàòÏöî Ï¶ùÍ∞Ä
            seasonalFactor = 1.15;
        } else if (currentMonth === 12 || currentMonth <= 2) {
            // Í≤®Ïö∏Ï≤† (12-2Ïõî): ÎÇúÎ∞©ÏúºÎ°ú Ï†ÑÎ†• ÏàòÏöî Ï¶ùÍ∞Ä
            seasonalFactor = 1.1;
        }
        
        const finalEnergyDemand = baseEnergyDemand * seasonalFactor;
        
        const result = Math.round(finalEnergyDemand * 10) / 10;
        console.log('üí° ÏµúÏ¢Ö ÏòàÏ∏° Ï†ÑÎ†•Îüâ:', result, 'kWh');
        return result;
    })();

    const MAX_INSIGHTS_PREVIEW = 5;
    let showAllInsights = false;

    $: insightsCount = energyForecast?.insights?.length || 0;
    $: visibleInsights = energyForecast?.insights
        ? showAllInsights
            ? energyForecast.insights
            : energyForecast.insights.slice(0, MAX_INSIGHTS_PREVIEW)
        : [];
</script>

<div class="demand-predictor">


    <!-- Ï†ÑÎ†•Îüâ ÏòàÏ∏° Í∏∞Í∞Ñ ÏÑ†ÌÉù -->
    <div class="forecast-period-selector">
        <div class="selector-header">
            <h3>Ï†ÑÎ†•Îüâ ÏàòÏöî ÏòàÏ∏° Í∏∞Í∞Ñ</h3>
            <select bind:value={energyForecastPeriod} class="period-select">
                {#each forecastPeriods as period}
                    <option value={period.value}>{period.label} ÏòàÏ∏°</option>
                {/each}
            </select>
        </div>
    </div>

    <div class="metrics-row">
        <MetricCard
            title="ÏùºÌèâÍ∑† ÏóêÎÑàÏßÄ"
            value={averageDailyEnergy}
            unit="kWh"
            type="energy"
            tooltip="ÏÑ†ÌÉùÎêú Í∏∞Í∞Ñ ÎèôÏïàÏùò ÏùºÏùº ÌèâÍ∑† ÏóêÎÑàÏßÄ ÏÜåÎπÑÎüâ"
        />
        <MetricCard
            title="Ï¥ù ÏóêÎÑàÏßÄ"
            value={totalEnergy}
            unit="kWh"
            type="total"
            tooltip="ÏÑ†ÌÉùÎêú Í∏∞Í∞Ñ ÎèôÏïàÏùò Ï¥ù ÏóêÎÑàÏßÄ ÏÜåÎπÑÎüâ"
        />
        <MetricCard
            title="Ï¶ùÍ∞ÄÏú®"
            value={growthRate}
            unit="%"
            type="growth"
            tooltip="Ï†Ñ Í∏∞Í∞Ñ ÎåÄÎπÑ ÏóêÎÑàÏßÄ ÏÜåÎπÑ Ï¶ùÍ∞ÄÏú®"
        />
        <MetricCard
            title="ÏòàÏÉÅ {forecastPeriods.find(p => p.value === energyForecastPeriod)?.label || 'ÏùºÍ∞Ñ'} Ï†ÑÎ†•Îüâ ÏàòÏöî"
            value={predictedEnergyDemand}
            unit="kWh"
            type={predictedEnergyDemand >= 200 ? "contract-high" : predictedEnergyDemand >= 100 ? "contract-medium" : "contract-low"}
            highlighted={true}
            tooltip="ÏóêÎÑàÏßÄ ÏÇ¨Ïö© Ìå®ÌÑ¥Í≥º ÏÑ±Ïû•Î•†ÏùÑ Í∏∞Î∞òÏúºÎ°ú Ìïú {forecastPeriods.find(p => p.value === energyForecastPeriod)?.label || 'ÏùºÍ∞Ñ'} Ï†ÑÎ†•Îüâ ÏòàÏ∏°"
        />
    </div>

    {#if energyForecast && !isLoading}
        <div class="chart-container-wrapper">
            <div class="chart-header">
                <h3>ÏùºÏùº Ï†ÑÎ†•Îüâ ÏÜåÎπÑ Ï∂îÏù¥</h3>
                <div class="chart-meta">
                    {#if dataRange.startDate && dataRange.endDate}
                        <div class="data-info">
                            <div class="data-period">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M8 2v4"></path>
                                    <path d="M16 2v4"></path>
                                    <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                                    <path d="M3 10h18"></path>
                                </svg>
                                <span>{dataRange.startDate.toLocaleDateString()} ~ {dataRange.endDate.toLocaleDateString()}</span>
                            </div>
                            <div class="data-stats">
                                <span class="stat-badge">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20V10"></path>
                                        <path d="M18 20V4"></path>
                                        <path d="M6 20v-6"></path>
                                    </svg>
                                    {dataRange.recordCount.toLocaleString()}Í∞ú
                                </span>
                                <span class="duration-badge">
                                    {Math.ceil((dataRange.endDate - dataRange.startDate) / (1000 * 60 * 60 * 24))}Ïùº
                                </span>
                            </div>
                        </div>
                    {:else}
                        <div class="no-data-info">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <span>Ï∂©Ï†ÑÏÜå {stationId} Îç∞Ïù¥ÌÑ∞ ÎØ∏Î∞úÍ≤¨</span>
                        </div>
                    {/if}
                    {#if lastUpdated}
                        <div class="last-updated-info">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12,6 12,12 16,14"></polyline>
                            </svg>
                            <span>ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏ : {lastUpdated.toLocaleTimeString()}</span>
                        </div>
                    {/if}
                    <div class="chart-controls">
                        <select bind:value={selectedTimeframe} class="timeframe-select-chart">
                            {#each timeframes as timeframe}
                                <option value={timeframe.value}>{timeframe.label}</option>
                            {/each}
                        </select>
                        <button class="zoom-reset-btn" on:click={resetZoom}>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M3 3v18h18" />
                                <path d="M18.5 9.5L12 16l-4-4-3.5 3.5" />
                            </svg>
                            ÏõêÎûòÎåÄÎ°ú
                        </button>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas bind:this={chartContainer}></canvas>
            </div>
        </div>
    {:else if isLoading}
        <div class="chart-container-wrapper">
            <div class="chart-loading">
                <LoadingSpinner />
                <p>ÏóêÎÑàÏßÄ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</p>
            </div>
        </div>
    {:else}
        <div class="chart-container-wrapper">
            <div class="no-chart-data">
                <div class="no-data-icon">üìâ</div>
                <h4>Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</h4>
                <p>ÏóêÎÑàÏßÄ ÏÜåÎπÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                <div class="data-check-info">
                    <p>Îã§Ïùå ÏÇ¨Ìï≠ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî</p>
                    <ul>
                        <li>Ï∂©Ï†ÑÏÜå IDÍ∞Ä Ïò¨Î∞îÎ•∏ÏßÄ ÌôïÏù∏</li>
                        <li>Îç∞Ïù¥ÌÑ∞ ÌååÏùºÏù¥ Ïò¨Î∞îÎ•¥Í≤å ÏóÖÎ°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏</li>
                        <li>ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏</li>
                    </ul>
                </div>
            </div>
        </div>

        {#if energyForecast && energyForecast.insights && energyForecast.insights.length > 0}
            <div class="insights-section">
                <div class="insights-header">
                    <span class="insights-icon">üí°</span>
                    <h3 class="insights-title">Ïù∏ÏÇ¨Ïù¥Ìä∏</h3>
                </div>
                <div class="insights-list">
                    {#each visibleInsights as insight, index}
                        <div
                            class="insight-item"
                            style="--delay: {index * 0.1}s"
                        >
                            <span class="insight-bullet">‚Ä¢</span>
                            <span class="insight-text">{insight}</span>
                        </div>
                    {/each}
                    {#if insightsCount > MAX_INSIGHTS_PREVIEW}
                        <button
                            class="show-more-btn"
                            on:click={() => (showAllInsights = !showAllInsights)}
                        >
                            {#if showAllInsights}Í∞ÑÎã®Ìûà Î≥¥Í∏∞{/if}
                            {#if !showAllInsights}Îçî Î≥¥Í∏∞ (+{insightsCount -
                                    MAX_INSIGHTS_PREVIEW}){/if}
                        </button>
                    {/if}
                </div>
            </div>
        {/if}
    {/if}

    {#if energyForecast && energyForecast.monthly_summary && energyForecast.monthly_summary.length > 0}
        <div class="monthly-summary">
            <h3>ÏõîÎ≥Ñ ÏóêÎÑàÏßÄ ÏÜåÎπÑ</h3>
            <div class="monthly-grid">
                {#each energyForecast.monthly_summary.slice(-6) as month}
                    <div class="month-card">
                        <div class="month-label">{month.month_label}</div>
                        <div class="month-total">
                            {month.total_energy.toFixed(1)}kWh
                        </div>
                        <div class="month-avg">
                            ÏùºÌèâÍ∑†: {month.avg_daily.toFixed(1)}kWh
                        </div>
                        <div class="month-days">{month.active_days}Ïùº ÌôúÎèô</div>
                    </div>
                {/each}
            </div>
        </div>
    {/if}
</div>

<style>
    /* Mobile-first base styles */
    .demand-predictor {
        background: transparent;
        border-radius: 0;
        padding: 24px;
        border: none;
        box-shadow: none;
        transition: all 0.3s ease;
    }

    /* Ï†ÑÎ†•Îüâ ÏòàÏ∏° Í∏∞Í∞Ñ ÏÑ†ÌÉùÍ∏∞ */
    .forecast-period-selector {
        margin-bottom: 24px;
        padding: 16px 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .selector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .selector-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .period-select {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 120px;
    }

    .period-select:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px var(--shadow);
    }

    .period-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }




    .metrics-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
    }

    .chart-container {
        height: 350px;
        width: 100%;
        position: relative;
    }

    .insights-section {
        margin: 32px 0;
        padding: 0;
    }

    .insights-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border-color);
    }

    .insights-icon {
        font-size: 1.5em;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .insights-title {
        margin: 0;
        color: var(--text-primary);
        font-size: 1.5em;
        font-weight: 600;
        letter-spacing: -0.025em;
    }

    .insights-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .insight-item {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 4px 0;
        opacity: 0;
        animation: fadeInUp 0.6s ease forwards;
        animation-delay: var(--delay);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .insight-bullet {
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1.2em;
        line-height: 1.5;
        flex-shrink: 0;
        margin-top: -2px;
    }

    .insight-text {
        color: var(--text-primary);
        font-size: 1em;
        line-height: 1.6;
        font-weight: 400;
    }

    .show-more-btn {
        align-self: flex-start;
        padding: 8px 16px;
        background: transparent;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition:
            background-color 0.2s ease,
            color 0.2s ease,
            transform 0.2s ease;
        margin-top: 8px;
    }

    .show-more-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    .monthly-summary {
        margin: 32px 0;
        padding: 24px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .monthly-summary h3 {
        margin: 0 0 20px 0;
        color: var(--text-primary);
        font-size: 1.2em;
        font-weight: 700;
    }

    .monthly-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
    }

    .month-card {
        background: var(--neutral-light);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        border: 1px solid var(--border-color);
        transition:
            transform 0.2s ease,
            box-shadow 0.2s ease;
    }

    .month-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px var(--shadow);
    }

    .month-label {
        font-size: 0.9em;
        color: var(--text-muted);
        font-weight: 600;
        margin-bottom: 8px;
    }

    .month-total {
        font-size: 1.4em;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 4px;
    }

    .month-avg {
        font-size: 0.8em;
        color: var(--text-secondary);
        margin-bottom: 2px;
    }

    .month-days {
        font-size: 0.75em;
        color: var(--text-muted);
    }

    .no-data-message {
        text-align: center;
        padding: 40px 20px;
        background: var(--neutral-light);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .no-data-icon {
        font-size: 3em;
        margin-bottom: 16px;
        opacity: 0.6;
    }

    .no-data-message h4 {
        margin: 0 0 12px 0;
        color: var(--text-primary);
        font-size: 1.2em;
        font-weight: 600;
    }

    .no-data-message p {
        margin: 0 0 20px 0;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    .data-check-info {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 16px;
        text-align: left;
        margin-top: 20px;
    }

    .data-check-info p {
        margin: 0 0 8px 0;
        font-weight: 600;
        color: var(--text-primary);
    }

    .data-check-info ul {
        margin: 0;
        padding-left: 20px;
        color: var(--text-secondary);
    }

    .data-check-info li {
        margin-bottom: 4px;
        font-size: 0.9em;
    }

    .chart-loading {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .chart-loading p {
        margin-top: 16px;
        font-size: 1.1em;
    }

    .chart-container-wrapper {
        margin-bottom: 24px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .chart-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .chart-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .chart-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .data-info {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .data-period {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .data-stats {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-badge, .duration-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .stat-badge {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .duration-badge {
        background: rgba(99, 102, 241, 0.1);
        color: #4f46e5;
        border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .no-data-info {
        display: flex;
        align-items: center;
        gap: 6px;
        color: #f59e0b;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .last-updated-info {
        display: flex;
        align-items: center;
        gap: 4px;
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .chart-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .timeframe-select-chart {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .timeframe-select-chart:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 4px var(--shadow);
    }

    .timeframe-select-chart:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }


    .zoom-reset-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .zoom-reset-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px var(--shadow);
    }

    .zoom-reset-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Îã§ÌÅ¨Î™®Îìú ÏßÄÏõê */
    :global([data-theme="dark"]) .data-info-card {
        --bg-secondary: #1f2937;
        --border-color: #374151;
        --shadow: rgba(0, 0, 0, 0.3);
        --shadow-hover: rgba(0, 0, 0, 0.5);
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --primary-color: #6366f1;
    }

    /* ÎùºÏù¥Ìä∏Î™®Îìú ÏßÄÏõê */
    :global([data-theme="light"]) .data-info-card {
        --bg-secondary: #ffffff;
        --border-color: rgba(0, 0, 0, 0.1);
        --shadow: rgba(0, 0, 0, 0.05);
        --shadow-hover: rgba(0, 0, 0, 0.15);
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --primary-color: #4f46e5;
    }

    /* Ïï†ÎãàÎ©îÏù¥ÏÖò ÏµúÏ†ÅÌôî */
    @media (prefers-reduced-motion: reduce) {
        .data-info-card {
            transition: none !important;
        }
    }

    /* ÌÉúÎ∏îÎ¶ø Î∞òÏùëÌòï */
    @media (min-width: 768px) {
        .chart-container {
            height: 450px;
        }

        .insights-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .monthly-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    /* Îç∞Ïä§ÌÅ¨ÌÜ± Î∞òÏùëÌòï */
    @media (min-width: 1024px) {
        .chart-container {
            height: 500px;
        }

        .monthly-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }

    /* Large Desktop Layout */
    @media (min-width: 1440px) {
        .demand-predictor {
            padding: 48px;
        }
    }

    @media (max-width: 768px) {
        .selector-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .period-select {
            width: 100%;
            min-width: unset;
        }

        .chart-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .data-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .data-stats {
            gap: 6px;
        }

        .stat-badge, .duration-badge {
            padding: 3px 6px;
            font-size: 0.75rem;
        }

        .last-updated-info {
            font-size: 0.8rem;
        }
    }
</style>